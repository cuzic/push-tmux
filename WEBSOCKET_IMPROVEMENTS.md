# WebSocket接続の改善内容

## 問題点と原因

WebSocketが突然切断される問題の主な原因：

1. **不十分なキープアライブ機構**
   - ping/pongメカニズムが実装されていなかった
   - nopメッセージの受信監視が不完全

2. **タイムアウト設定の問題**
   - 30秒のタイムアウトが短すぎる
   - Pushbulletのnopメッセージは約30秒間隔なので、タイミングによってタイムアウトが発生

3. **再接続ロジックの不備**
   - 再接続時のエラーハンドリングが不完全
   - 無限再接続による過負荷の可能性

4. **デバッグ情報の不足**
   - 接続状態やエラーの詳細が分からない
   - 問題の原因特定が困難

## 実装した改善内容

### 1. WebSocket ping/pong の実装
```python
self.websocket = await websockets.connect(
    self.ws_url,
    ping_interval=30,      # 30秒ごとにpingを送信
    ping_timeout=10,       # pongの応答待ち時間
    close_timeout=10       # 接続クローズ時のタイムアウト
)
```

### 2. タイムアウト設定の最適化
- WebSocketタイムアウト: 30秒 → 60秒に延長
- nopメッセージ監視: 120秒（タイムアウトの2倍）まで許容

### 3. 改善された再接続ロジック
- 最大再接続試行回数: 10回
- エクスポネンシャルバックオフ: 再接続間隔を徐々に増加
- 接続状態の適切な管理

### 4. ロギング機能の追加
- デバッグモード: `--debug`オプションで詳細ログを表示
- ログレベル: INFO（通常）/ DEBUG（詳細）
- 各種イベントのログ出力

### 5. エラーハンドリングの強化
- ConnectionClosedError と ConnectionClosedOK を区別
- JSONデコードエラーの処理
- 予期しないエラーからの回復

## 使用方法

### 通常モード
```bash
push-tmux listen
```

### デバッグモード（詳細ログ付き）
```bash
push-tmux listen --debug
```

### 接続安定性テスト
```bash
python test_websocket_stability.py
```

## 期待される効果

1. **接続の安定性向上**
   - ping/pongによる接続維持
   - 適切なタイムアウト設定で不要な切断を回避

2. **自動回復機能**
   - 接続切断時の自動再接続
   - エラー時の適切なリトライ

3. **問題の可視化**
   - ログによる接続状態の監視
   - エラー原因の特定が容易

4. **長時間稼働の実現**
   - 24時間以上の連続稼働が可能
   - ネットワーク一時障害からの自動回復

## トラブルシューティング

### 頻繁に切断される場合
1. デバッグモードで実行して原因を特定
2. ネットワーク環境の確認（プロキシ、ファイアウォール）
3. タイムアウト値の調整（WEBSOCKET_TIMEOUT）

### 再接続が失敗する場合
1. APIキーの有効性を確認
2. Pushbulletサービスの状態を確認
3. MAX_RECONNECT_ATTEMPTSの値を増やす

### メッセージを受信しない場合
1. デバイス登録状態の確認
2. メッセージのターゲットデバイス設定を確認
3. tickleメッセージの処理ログを確認