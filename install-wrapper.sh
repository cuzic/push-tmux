#!/bin/bash
# push-tmux wrapper installer
# Installs the push-tmux wrapper script to a directory in PATH

set -e

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆ
DEFAULT_INSTALL_DIR="$HOME/.local/bin"
INSTALL_DIR="${1:-$DEFAULT_INSTALL_DIR}"
PUSH_TMUX_DIR="$(cd "$(dirname "$0")" && pwd)"

# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    cat << EOF
Usage: $0 [INSTALL_DIR]

Install push-tmux wrapper script to make it available from any directory.

Arguments:
  INSTALL_DIR    Directory to install the wrapper (default: $DEFAULT_INSTALL_DIR)

Examples:
  $0                    # Install to $DEFAULT_INSTALL_DIR
  $0 /usr/local/bin     # Install to /usr/local/bin (may require sudo)
  $0 ~/.local/bin       # Install to ~/.local/bin

After installation, you can run 'push-tmux' from any directory.
EOF
    exit 0
fi

echo "ğŸ”§ Installing push-tmux wrapper..."
echo "ğŸ“ Project directory: $PUSH_TMUX_DIR"
echo "ğŸ“¦ Install directory: $INSTALL_DIR"

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
if [ ! -d "$INSTALL_DIR" ]; then
    echo "ğŸ“‚ Creating install directory: $INSTALL_DIR"
    mkdir -p "$INSTALL_DIR"
fi

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if [ ! -w "$INSTALL_DIR" ]; then
    echo "âŒ Error: No write permission to $INSTALL_DIR" >&2
    echo "Try running with sudo or choose a different directory" >&2
    exit 1
fi

# ãƒ©ãƒƒãƒ‘ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ
WRAPPER_PATH="$INSTALL_DIR/push-tmux"
cat > "$WRAPPER_PATH" << EOF
#!/bin/bash
# push-tmux wrapper - generated by install-wrapper.sh
# Project path: $PUSH_TMUX_DIR

PUSH_TMUX_DIR="$PUSH_TMUX_DIR"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if [ ! -d "\$PUSH_TMUX_DIR" ]; then
    echo "Error: push-tmux directory not found at \$PUSH_TMUX_DIR" >&2
    echo "The project may have been moved or deleted" >&2
    exit 1
fi

# pyproject.tomlãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if [ ! -f "\$PUSH_TMUX_DIR/pyproject.toml" ]; then
    echo "Error: \$PUSH_TMUX_DIR doesn't appear to be a push-tmux project" >&2
    echo "pyproject.toml not found" >&2
    exit 1
fi

# uvãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
if ! command -v uv >/dev/null 2>&1; then
    echo "Error: uv is not installed" >&2
    echo "Please install uv: https://github.com/astral-sh/uv" >&2
    exit 1
fi

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦å®Ÿè¡Œ
cd "\$PUSH_TMUX_DIR" && exec uv run python -m push_tmux "\$@"
EOF

# å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸
chmod +x "$WRAPPER_PATH"

echo "âœ… push-tmux wrapper installed successfully!"
echo ""
echo "ğŸ‰ You can now run push-tmux from any directory:"
echo "   push-tmux --help"
echo "   push-tmux register"
echo "   push-tmux listen"
echo ""

# PATHã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if ! echo "$PATH" | tr ':' '\n' | grep -q "^$INSTALL_DIR$"; then
    echo "âš ï¸  Warning: $INSTALL_DIR is not in your PATH"
    echo "   Add this line to your ~/.bashrc or ~/.zshrc:"
    echo "   export PATH=\"$INSTALL_DIR:\$PATH\""
    echo ""
fi

echo "ğŸ—‘ï¸  To uninstall, simply run: rm $WRAPPER_PATH"