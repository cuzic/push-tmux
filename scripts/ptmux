#!/bin/bash

# ptmux - push-tmux簡易起動スクリプト
# 
# カレントディレクトリ名を使って素早くpush-tmuxセッションを開始する
#
# Usage: ptmux [session-name]

set -e

# カラー定義
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# セッション名（引数があれば使用、なければディレクトリ名）
SESSION="${1:-$(basename $(pwd))}"
DEVICE_NAME="$SESSION"

# .envファイルの読み込み
if [ -f .env ]; then
    export $(grep -v '^#' .env | xargs)
fi

# 環境チェック
if [ -z "$PUSHBULLET_TOKEN" ]; then
    echo -e "${RED}エラー: PUSHBULLET_TOKEN が設定されていません${NC}"
    echo "以下のコマンドで設定してください:"
    echo "  echo 'PUSHBULLET_TOKEN=your-token-here' > .env"
    exit 1
fi

# push-tmuxコマンドの検出
if command -v mise &> /dev/null; then
    PUSH_TMUX_CMD="mise exec -- push-tmux"
elif command -v push-tmux &> /dev/null; then
    PUSH_TMUX_CMD="push-tmux"
else
    echo -e "${RED}エラー: push-tmuxが見つかりません${NC}"
    exit 1
fi

# 既存セッションチェック
if tmux has-session -t "$SESSION" 2>/dev/null; then
    echo -e "${YELLOW}セッション '$SESSION' は既に存在します${NC}"
    echo -n "再接続しますか？ [Y/n]: "
    read -r response
    if [[ ! "$response" =~ ^[Nn]$ ]]; then
        exec tmux attach -t "$SESSION"
    else
        exit 0
    fi
fi

echo -e "${GREEN}セットアップ中: $SESSION${NC}"

# デバイス登録（未登録の場合のみ）
if ! DEVICE_NAME="$DEVICE_NAME" $PUSH_TMUX_CMD list-devices 2>/dev/null | grep -q "$DEVICE_NAME"; then
    echo "  📱 デバイス '$DEVICE_NAME' を登録..."
    DEVICE_NAME="$DEVICE_NAME" $PUSH_TMUX_CMD register --name "$DEVICE_NAME" >/dev/null 2>&1
fi

# tmuxセッション作成
echo "  🖥️  tmuxセッション作成..."
tmux new-session -d -s "$SESSION" -n "listener"
tmux new-window -t "$SESSION:1" -n "main"

# リスナー起動
echo "  📡 push-tmuxリスナー起動..."
tmux send-keys -t "$SESSION:0" "DEVICE_NAME='$DEVICE_NAME' $PUSH_TMUX_CMD listen" C-m

# メインウィンドウに切り替え
tmux select-window -t "$SESSION:1"

echo -e "${GREEN}✓ セットアップ完了！${NC}"
echo ""
echo "デバイス名: $DEVICE_NAME"
echo "Pushbulletから '$DEVICE_NAME' 宛にメッセージを送信してください"
echo ""

# アタッチ
exec tmux attach -t "$SESSION"